package org.raygoza.bx.rPrimer;

import java.awt.Toolkit;
import java.awt.datatransfer.Clipboard;
import java.awt.datatransfer.StringSelection;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.BufferedReader;
import java.io.OutputStream;
import java.io.StringReader;
import java.io.StringWriter;
import java.net.URL;
import java.util.Vector;

import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JTextField;
import javax.swing.UIManager;

import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.URI;
import org.apache.commons.httpclient.methods.PostMethod;
import org.apache.commons.httpclient.methods.StringRequestEntity;


public class PrimerSelect extends JFrame {


	public PrimerSelect() {
		initComponents();
	}

	/* This method is called from within the constructor to initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
	// <editor-fold defaultstate="collapsed" desc="Generated Code">
	private void initComponents() {

		jMenuBar1 = new javax.swing.JMenuBar();
		jMenu1 = new javax.swing.JMenu();
		jMenu2 = new javax.swing.JMenu();
		jToolBar1 = new javax.swing.JToolBar();
		jButton1 = new javax.swing.JButton();
		jTabbedPane1 = new javax.swing.JTabbedPane();
		jPanel1 = new javax.swing.JPanel();
		jScrollPane1 = new javax.swing.JScrollPane();
		jTextArea1 = new javax.swing.JTextArea();
		jComboBox1 = new javax.swing.JComboBox();
		jLabel1 = new javax.swing.JLabel();
		jButton2 = new javax.swing.JButton();
		jMenuBar2 = new javax.swing.JMenuBar();
		jMenu3 = new javax.swing.JMenu();
		jMenu4 = new javax.swing.JMenu();
		analizeseq = new JLabel("Region to analyze:");
		astart = new JTextField();
		aend = new JTextField();
		
		jMenu1.setText("File");
		jMenuBar1.add(jMenu1);

		jMenu2.setText("Edit");
		jMenuBar1.add(jMenu2);

		setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);

		jToolBar1.setRollover(true);

		jButton1.setText("save fasta");
		jButton1.setFocusable(false);
		jButton1.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
		jButton1.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);

		JButton copyTab = new JButton("Copy TAB");
		copyTab.setFocusable(false);
		copyTab.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
		copyTab.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);

		copyTab.addActionListener(new ActionListener() {

			@Override
			public void actionPerformed(ActionEvent arg0) {
				String output = "OLIGO\tstart\tlen\ttm\tgc%\tany\t3'\tseq\n";
				try {
					for(ResultPanel rsp: panels) {
						String primer_info = getPrimerText(rsp.getText());
						output+= primer_info.replaceAll("[ ]+","\t")+"\n";
					}

					StringSelection stringSelection = new StringSelection(output.trim());
					Clipboard clpbrd = Toolkit.getDefaultToolkit().getSystemClipboard();
					clpbrd.setContents (stringSelection, null);

				}catch(Exception ex) {
					ex.printStackTrace();
				}


			}
		});

		JButton clear = new JButton("clear");

		clear.addActionListener(new ActionListener() {

			@Override
			public void actionPerformed(ActionEvent e) {
				if(panels.size()>0) {
					if(jTabbedPane1.getTabCount()==3) {
						jTabbedPane1.remove(1);
						jTabbedPane1.remove(1);
					}else {
						jTabbedPane1.remove(1);
					}
				}
				panels.clear();
				jTextArea1.setText("");
				jTextArea1.requestFocus();
			}
		});
		
		JButton copyfasta = new JButton("copy as fasta");
		
		copyfasta.addActionListener(new ActionListener() {
			
			@Override
			public void actionPerformed(ActionEvent arg0) {
				String output="";
				
				String seqname = JOptionPane.showInputDialog("Enter the name for this sequence (without >)");
				
				if(seqname!=null && !seqname.trim().equals("")) {
					seqname=seqname.trim();
				}else {
					JOptionPane.showMessageDialog(null, "You must enter a valid name!!");
					return;
				}
				output+=">"+seqname+"5p"+"\n";
				
				try {
					ResultPanel rsp = panels.elementAt(0);
						String primer_info = getPrimerText(rsp.getText());
						String[] vals =primer_info.replaceAll("[ ]+","\t").split("\t");
						output+= vals[vals.length-1].trim()+"\n";
						rsp = panels.elementAt(1);
						output +=">"+seqname+"3p"+"\n";
						primer_info = getPrimerText(rsp.getText());
						vals =primer_info.replaceAll("[ ]+","\t").split("\t");
						output+= vals[vals.length-1].trim()+"\n";

					StringSelection stringSelection = new StringSelection(output.trim());
					Clipboard clpbrd = Toolkit.getDefaultToolkit().getSystemClipboard();
					clpbrd.setContents (stringSelection, null);

				}catch(Exception ex) {
					ex.printStackTrace();
				}
				
			}
		});

		jToolBar1.add(jButton1);
		jToolBar1.add(copyTab);
		jToolBar1.add(clear);
		jToolBar1.add(copyfasta);
		seqname = new JTextField();
		seqname.setText("");
		getContentPane().add(jToolBar1, java.awt.BorderLayout.PAGE_START);

		jPanel1.setLayout(null);

		jTextArea1.setColumns(20);
		jTextArea1.setRows(5);
		jScrollPane1.setViewportView(jTextArea1);

		jPanel1.add(jScrollPane1);
		jScrollPane1.setBounds(50, 20, 460, 100);

		jComboBox1.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "------> <------", "<------ ------>", "------>", "<------" }));
		jPanel1.add(jComboBox1);
		jComboBox1.setBounds(160, 130, 196, 27);

		analizeseq.setBounds(50,160,120,16);
		astart.setBounds(220, 160, 40, 17);
		jPanel1.add(astart);
		aend.setBounds(270, 160, 40, 17);
		jPanel1.add(aend);
		astart.setText("1");
		aend.setText("100");
		jPanel1.add(analizeseq);
		
		
		jLabel1.setText("Primer Set Type:");
		jPanel1.add(jLabel1);
		jLabel1.setBounds(50, 130, 120, 16);

		jButton2.setText("Find Primers!");
		jPanel1.add(jButton2);
		jButton2.setBounds(50, 200, 110, 29);
		jButton2.addActionListener(new ActionListener() {

			@Override
			public void actionPerformed(ActionEvent arg0) {

				if(jTextArea1.getText().trim().length()>=0) {

					HttpClient client = new HttpClient();
					String[] primer_set = jComboBox1.getSelectedItem().toString().split(" ");



					String sequence = jTextArea1.getText().replace("\n", "");

					String left_sequence="";
					String right_sequence="";

					if(primer_set[0].startsWith("-----")) {
						left_sequence = sequence.substring(Integer.parseInt(astart.getText()),Integer.parseInt(aend.getText()));
					}

					if(primer_set.length>1) {
						if(primer_set[1	].startsWith("<---")) {
							right_sequence = sequence.substring(sequence.length()-Integer.parseInt(aend.getText()),sequence.length()-1-Integer.parseInt(astart.getText()));
						}	
					}

					try {

						
						Primer3Interfacer primer3 = new Primer3Interfacer("http://biotools.umassmed.edu/bioapps/primer3_www_results.cgi");
					//	PostMethod left = new PostMethod("http://biotools.umassmed.edu/bioapps/primer3_www_results.cgi");


						//StringRequestEntity sre = new StringRequestEntity("PRIMER_MISPRIMING_LIBRARY=NONE&SEQUENCE="+left_sequence+"&MUST_XLATE_PICK_LEFT=1&PRIMER_LEFT_INPUT=&PRIMER_INTERNAL_OLIGO_INPUT=&PRIMER_RIGHT_INPUT=&Pick+Primers=Pick+Primers&PRIMER_SEQUENCE_ID="+seqname.getText().trim()+"&TARGET=&EXCLUDED_REGION=&MUST_XLATE_PRODUCT_MIN_SIZE=100&PRIMER_PRODUCT_OPT_SIZE=200&MUST_XLATE_PRODUCT_MAX_SIZE=1000&PRIMER_NUM_RETURN=5&PRIMER_MAX_END_STABILITY=9.0&PRIMER_MAX_MISPRIMING=12.00&PRIMER_PAIR_MAX_MISPRIMING=24.00&PRIMER_MIN_SIZE=21&PRIMER_OPT_SIZE=23&PRIMER_MAX_SIZE=25&PRIMER_MIN_TM=57.0&PRIMER_OPT_TM=60.0&PRIMER_MAX_TM=63.0&PRIMER_MAX_DIFF_TM=100.0&PRIMER_PRODUCT_MIN_TM=&PRIMER_PRODUCT_OPT_TM=&PRIMER_PRODUCT_MAX_TM=&PRIMER_MIN_GC=20.0&PRIMER_OPT_GC_PERCENT=&PRIMER_MAX_GC=80.0&PRIMER_SELF_ANY=8.00&PRIMER_SELF_END=3.00&PRIMER_NUM_NS_ACCEPTED=0&PRIMER_MAX_POLY_X=5&PRIMER_INSIDE_PENALTY=&PRIMER_OUTSIDE_PENALTY=0&PRIMER_FIRST_BASE_INDEX=1&PRIMER_GC_CLAMP=0&PRIMER_SALT_CONC=50.0&PRIMER_DNA_CONC=50.0&PRIMER_LIBERAL_BASE=1&INCLUDED_REGION=&PRIMER_START_CODON_POSITION=&PRIMER_SEQUENCE_QUALITY=+&PRIMER_MIN_QUALITY=0&PRIMER_MIN_END_QUALITY=0&PRIMER_QUALITY_RANGE_MIN=0&PRIMER_QUALITY_RANGE_MAX=100&PRIMER_WT_TM_LT=1.0&PRIMER_WT_TM_GT=1.0&PRIMER_WT_SIZE_LT=1.0&PRIMER_WT_SIZE_GT=1.0&PRIMER_WT_GC_PERCENT_LT=0.0&PRIMER_WT_GC_PERCENT_GT=0.0&PRIMER_WT_COMPL_ANY=0.0&PRIMER_WT_COMPL_END=0.0&PRIMER_WT_NUM_NS=0.0&PRIMER_WT_REP_SIM=0.0&PRIMER_WT_SEQ_QUAL=0.0&PRIMER_WT_END_QUAL=0.0&PRIMER_WT_POS_PENALTY=0.0&PRIMER_WT_END_STABILITY=0.0&PRIMER_PAIR_WT_PRODUCT_SIZE_LT=0.05&PRIMER_PAIR_WT_PRODUCT_SIZE_GT=0.05&PRIMER_PAIR_WT_PRODUCT_TM_LT=0.0&PRIMER_PAIR_WT_PRODUCT_TM_GT=0.0&PRIMER_PAIR_WT_DIFF_TM=0.0&PRIMER_PAIR_WT_COMPL_ANY=0.0&PRIMER_PAIR_WT_COMPL_END=0.0&PRIMER_PAIR_WT_REP_SIM=0.0&PRIMER_PAIR_WT_PR_PENALTY=1.0&PRIMER_PAIR_WT_IO_PENALTY=0.0&PRIMER_INTERNAL_OLIGO_EXCLUDED_REGION=&PRIMER_INTERNAL_OLIGO_MIN_SIZE=18&PRIMER_INTERNAL_OLIGO_OPT_SIZE=20&PRIMER_INTERNAL_OLIGO_MAX_SIZE=27&PRIMER_INTERNAL_OLIGO_MIN_TM=57.0&PRIMER_INTERNAL_OLIGO_OPT_TM=60.0&PRIMER_INTERNAL_OLIGO_MAX_TM=63.0&PRIMER_INTERNAL_OLIGO_MIN_GC=20.0&PRIMER_INTERNAL_OLIGO_OPT_GC_PERCENT=&PRIMER_INTERNAL_OLIGO_MAX_GC=80.0&PRIMER_INTERNAL_OLIGO_SELF_ANY=12.00&PRIMER_INTERNAL_OLIGO_SELF_END=12.00&PRIMER_INTERNAL_OLIGO_NUM_NS=0&PRIMER_INTERNAL_OLIGO_MAX_POLY_X=5&PRIMER_INTERNAL_OLIGO_MISHYB_LIBRARY=NONE&PRIMER_INTERNAL_OLIGO_MAX_MISHYB=12.00&PRIMER_INTERNAL_OLIGO_MIN_QUALITY=0&PRIMER_INTERNAL_OLIGO_SALT_CONC=50.0&PRIMER_INTERNAL_OLIGO_DNA_CONC=50.0&PRIMER_IO_WT_TM_LT=1.0&PRIMER_IO_WT_TM_GT=1.0&PRIMER_IO_WT_SIZE_LT=1.0&PRIMER_IO_WT_SIZE_GT=1.0&PRIMER_IO_WT_GC_PERCENT_LT=0.0&PRIMER_IO_WT_GC_PERCENT_GT=0.0&PRIMER_IO_WT_COMPL_ANY=0.0&PRIMER_IO_WT_NUM_NS=0.0&PRIMER_IO_WT_REP_SIM=0.0&PRIMER_IO_WT_SEQ_QUAL=0.0");
						//left.setRequestEntity(sre);

						
						
						//PostMethod right = new PostMethod("http://biotools.umassmed.edu/bioapps/primer3_www_results.cgi");

						/*StringRequestEntity rsre = new StringRequestEntity("PRIMER_MISPRIMING_LIBRARY=NONE&SEQUENCE=" +right_sequence+
								"&MUST_XLATE_PICK_RIGHT=1&PRIMER_LEFT_INPUT=&PRIMER_INTERNAL_OLIGO_INPUT=&PRIMER_RIGHT_INPUT=&Pick+Primers=Pick+Primers&PRIMER_SEQUENCE_ID="+seqname.getText().trim()+"&TARGET=&EXCLUDED_REGION=&MUST_XLATE_PRODUCT_MIN_SIZE=100&PRIMER_PRODUCT_OPT_SIZE=230&MUST_XLATE_PRODUCT_MAX_SIZE=" +
								"1000&PRIMER_NUM_RETURN=5&PRIMER_MAX_END_STABILITY=9.0&PRIMER_MAX_MISPRIMING=12.00&PRIMER_PAIR_MAX_MISPRIMING=24.00&PRIMER_MIN_SIZE=21&PRIMER_OPT_SIZE=23&PRIMER_MAX_SIZE=25&PRIMER_MIN_TM=57.0&PRIMER_OPT_TM=60.0&PRIMER_MAX_TM=63.0&PRIMER_MAX_DIFF_TM=100.0&PRIMER_PRODUCT_" +
								"MIN_TM=&PRIMER_PRODUCT_OPT_TM=&PRIMER_PRODUCT_MAX_TM=&PRIMER_MIN_GC=20.0&PRIMER_OPT_GC_PERCENT=&PRIMER_MAX_GC=80.0&PRIMER_SELF_ANY=8.00&PRIMER_SELF_END=3.00&PRIMER_NUM_NS_ACCEPTED=0&PRIMER_MAX_POLY_X=5&PRIMER_INSIDE_PENALTY=&PRIMER_OUTSIDE_PENALTY=0&PRIMER_FIRST_BASE_I" +
								"NDEX=1&PRIMER_GC_CLAMP=0&PRIMER_SALT_CONC=50.0&PRIMER_DNA_CONC=50.0&PRIMER_LIBERAL_BASE=1&INCLUDED_REGION=&PRIMER_START_CODON_POSITION=&PRIMER_SEQUENCE_QUALITY=+&PRIMER_MIN_QUALITY=0&PRIMER_MIN_END_QUALITY=0&PRIMER_QUALITY_RANGE_MIN=0&PRIMER_QUALITY_RANGE_MAX=100&PRIME" +
								"R_WT_TM_LT=1.0&PRIMER_WT_TM_GT=1.0&PRIMER_WT_SIZE_LT=1.0&PRIMER_WT_SIZE_GT=1.0&PRIMER_WT_GC_PERCENT_LT=0.0&PRIMER_WT_GC_PERCENT_GT=0.0&PRIMER_WT_COMPL_ANY=0.0&PRIMER_WT_COMPL_END=0.0&PRIMER_WT_NUM_NS=0.0&PRIMER_WT_REP_SIM=0.0&PRIMER_WT_SEQ_QUAL=0.0&PRIMER_WT_END_QUAL=0" +
								".0&PRIMER_WT_POS_PENALTY=0.0&PRIMER_WT_END_STABILITY=0.0&PRIMER_PAIR_WT_PRODUCT_SIZE_LT=0.05&PRIMER_PAIR_WT_PRODUCT_SIZE_GT=0.05&PRIMER_PAIR_WT_PRODUCT_TM_LT=0.0&PRIMER_PAIR_WT_PRODUCT_TM_GT=0.0&PRIMER_PAIR_WT_DIFF_TM=0.0&PRIMER_PAIR_WT_COMPL_ANY=0.0&PRIMER_PAIR_WT_COM" +
								"PL_END=0.0&PRIMER_PAIR_WT_REP_SIM=0.0&PRIMER_PAIR_WT_PR_PENALTY=1.0&PRIMER_PAIR_WT_IO_PENALTY=0.0&PRIMER_INTERNAL_OLIGO_EXCLUDED_REGION=&PRIMER_INTERNAL_OLIGO_MIN_SIZE=18&PRIMER_INTERNAL_OLIGO_OPT_SIZE=20&PRIMER_INTERNAL_OLIGO_MAX_SIZE=27&PRIMER_INTERNAL_OLIGO_MIN_TM=5" +
								"7.0&PRIMER_INTERNAL_OLIGO_OPT_TM=60.0&PRIMER_INTERNAL_OLIGO_MAX_TM=63.0&PRIMER_INTERNAL_OLIGO_MIN_GC=20.0&PRIMER_INTERNAL_OLIGO_OPT_GC_PERCENT=&PRIMER_INTERNAL_OLIGO_MAX_GC=80.0&PRIMER_INTERNAL_OLIGO_SELF_ANY=12.00&PRIMER_INTERNAL_OLIGO_SELF_END=12.00&PRIMER_INTERNAL_O" +
								"LIGO_NUM_NS=0&PRIMER_INTERNAL_OLIGO_MAX_POLY_X=5&PRIMER_INTERNAL_OLIGO_MISHYB_LIBRARY=NONE&PRIMER_INTERNAL_OLIGO_MAX_MISHYB=12.00&PRIMER_INTERNAL_OLIGO_MIN_QUALITY=0&PRIMER_INTERNAL_OLIGO_SALT_CONC=50.0&PRIMER_INTERNAL_OLIGO_DNA_CONC=50.0&PRIMER_IO_WT_TM_LT=1.0&PRIMER_" +
								"IO_WT_TM_GT=1.0&PRIMER_IO_WT_SIZE_LT=1.0&PRIMER_IO_WT_SIZE_GT=1.0&PRIMER_IO_WT_GC_PERCENT_LT=0.0&PRIMER_IO_WT_GC_PERCENT_GT=0.0&PRIMER_IO_WT_COMPL_ANY=0.0&PRIMER_IO_WT_NUM_NS=0.0&PRIMER_IO_WT_REP_SIM=0.0&PRIMER_IO_WT_SEQ_QUAL=0.0");
						right.setRequestEntity(rsre);*/






						//client.executeMethod(left);


						ResultPanel left_panel = new ResultPanel(primer3.getLeftPrimerInfo("", left_sequence).rawHtml());

						//client.executeMethod(right);
						ResultPanel right_panel = new ResultPanel(primer3.getRightPrimerInfo("", right_sequence).rawHtml());
						for(ResultPanel rs : panels) {
							jTabbedPane1.remove(rs);
						}
						panels.clear();
						panels.add(left_panel);
						panels.add(right_panel);
						jTabbedPane1.addTab("5' primer", left_panel);
						jTabbedPane1.addTab("3' primer", right_panel);
					}catch(Exception ex) {
						ex.printStackTrace();
					}

				}


			}
		});

		jTabbedPane1.addTab("Settings", jPanel1);

		getContentPane().add(jTabbedPane1, java.awt.BorderLayout.CENTER);

		jMenu3.setText("File");
		jMenuBar2.add(jMenu3);

		jMenu4.setText("Edit");
		jMenuBar2.add(jMenu4);

		setJMenuBar(jMenuBar2);

		setSize(585,456);
		setLocationRelativeTo(null);

	}// </editor-fold>


	private String getPrimerText(String text) throws Exception{


		String line="";
		BufferedReader rd = new BufferedReader(new StringReader(text));

		while(true) {
			line=rd.readLine();
			if(line==null) break;

			if(line.trim().toLowerCase().startsWith("left_primer")) {
				return line;
			}
			if(line.trim().toLowerCase().startsWith("right_primer")) {
				return line;
			}
		}

		return "";
	}
	/**
	 * @param args the command line arguments
	 */
	public static void main(String args[]) {
		/* Set the Nimbus look and feel */
		//<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
		/* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
		 * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
		 */
		try {

			javax.swing.UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());



		} catch (ClassNotFoundException ex) {
			java.util.logging.Logger.getLogger(PrimerSelect.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		} catch (InstantiationException ex) {
			java.util.logging.Logger.getLogger(PrimerSelect.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		} catch (IllegalAccessException ex) {
			java.util.logging.Logger.getLogger(PrimerSelect.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		} catch (javax.swing.UnsupportedLookAndFeelException ex) {
			java.util.logging.Logger.getLogger(PrimerSelect.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		}
		//</editor-fold>

		/* Create and display the form */
		java.awt.EventQueue.invokeLater(new Runnable() {
			public void run() {
				new PrimerSelect().setVisible(true);
			}
		});
	}
	// Variables declaration - do not modify
	private javax.swing.JButton jButton1;
	private javax.swing.JButton jButton2;
	private javax.swing.JComboBox jComboBox1;
	private javax.swing.JLabel jLabel1;
	private javax.swing.JMenu jMenu1;
	private javax.swing.JMenu jMenu2;
	private javax.swing.JMenu jMenu3;
	private javax.swing.JMenu jMenu4;
	private javax.swing.JMenuBar jMenuBar1;
	private javax.swing.JMenuBar jMenuBar2;
	private javax.swing.JPanel jPanel1;
	private javax.swing.JScrollPane jScrollPane1;
	private javax.swing.JTabbedPane jTabbedPane1;
	private javax.swing.JTextArea jTextArea1;
	private javax.swing.JToolBar jToolBar1;
	private Vector<ResultPanel> panels = new Vector<ResultPanel>();
	private JLabel seqnamelab ;
	private JTextField seqname;
	private JLabel analizeseq;
	private JTextField astart;
	private JTextField aend;
	
	// End of variables declaration

}
